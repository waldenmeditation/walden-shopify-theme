<script>
  console.log('Building variant media map with waterfall logic...');
  const variantMediaMap = {};

  // Separate "all" images from variant-specific images
  const allMedia = [
    {%- for media in product.media -%}
      {%- if media.alt == "all" -%}
        {{ media | json }},
      {%- endif -%}
    {%- endfor -%}
  ].filter(Boolean);

  // Product media excluding "skip" and "all" images
  const productMedia = [
    {%- for media in product.media -%}
      {%- unless media.alt contains "skip" or media.alt == "all" -%}
        {{ media | json }}{% unless forloop.last %},{% endunless %}
      {%- endunless -%}
    {%- endfor -%}
  ];
  const productVariants = {{ product.variants | json }};

  console.log('Product Media:', productMedia);
  console.log('All-variant Media:', allMedia);
  console.log('Product Variants:', productVariants);

  const mediaIdToIndex = new Map(productMedia.map((media, index) => [media.id, index]));

  const variantFeaturedMediaIndices = productVariants.map(variant => {
    if (variant.featured_media) {
      return mediaIdToIndex.get(variant.featured_media.id);
    }
    return -1;
  }).filter(index => index !== -1);

  console.log('Variant Featured Media Indices:', variantFeaturedMediaIndices);

  if (productVariants.length === 1) {
    const variant = productVariants[0];
    variantMediaMap[variant.id] = [...productMedia, ...allMedia];
  } else {
    productVariants.forEach((variant, i) => {
      if (!variant.featured_media) {
        variantMediaMap[variant.id] = [...allMedia];
        return;
      }

      const startIndex = mediaIdToIndex.get(variant.featured_media.id);
      let endIndex;

      // Find the next variant's featured media index
      let nextVariantIndex = -1;
      for (let j = i + 1; j < productVariants.length; j++) {
        if (productVariants[j].featured_media) {
          nextVariantIndex = mediaIdToIndex.get(productVariants[j].featured_media.id);
          break;
        }
      }

      if (nextVariantIndex !== -1) {
        endIndex = nextVariantIndex;
      } else {
        endIndex = productMedia.length;
      }

      console.log(`Slicing for variant ${variant.id}: from ${startIndex} to ${endIndex}`);
      // Combine variant-specific images with "all" images
      variantMediaMap[variant.id] = [...productMedia.slice(startIndex, endIndex), ...allMedia];
    });
  }

  console.log('Final Variant Media Map:', variantMediaMap);

  const scriptTag = document.createElement('script');
  scriptTag.type = 'application/json';
  scriptTag.setAttribute('data-variant-images', '');
  scriptTag.textContent = JSON.stringify(variantMediaMap);
  document.head.appendChild(scriptTag);
</script>