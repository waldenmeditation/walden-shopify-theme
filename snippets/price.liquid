{% doc %}
  This snippet is used to render a product card.
  It is used in the product block, featured product block, and the product card block.

  @param {product} product_resource - The product to render
  @param {boolean} [show_unit_price] - Whether to show the unit price
  @param {boolean} [show_sale_price_first] - Whether to show the sale price first
{% enddoc %}

{%- liquid
  assign show_unit_price = show_unit_price | default: false
  assign show_sale_price_first = show_sale_price_first | default: false

  assign selected_variant = product_resource.selected_or_first_available_variant

  # Keep raw cents for logic
  assign price_cents = selected_variant.price
  assign compare_cents = selected_variant.compare_at_price | default: 0

  # Theme editor mock (display only)
  if product_resource == blank and request.design_mode
    assign price_cents = 1999
    assign compare_cents = 2999
  endif

  # Prepare formatted strings for display only
  assign price_display = price_cents
  assign compare_display = compare_cents

  if product.handle == closest.product.handle and settings.currency_code_enabled_product_pages
    assign price_display = price_cents | money_with_currency
    assign compare_display = compare_cents | money_with_currency
  elsif product.handle != closest.product.handle and settings.currency_code_enabled_product_cards
    assign price_display = price_cents | money_with_currency
    assign compare_display = compare_cents | money_with_currency
  else
    assign price_display = price_cents | money
    assign compare_display = compare_cents | money
  endif
-%}

{%- assign has_sale = false -%}
{%- if compare_cents and price_cents and compare_cents > price_cents -%}
  {%- assign has_sale = true -%}
{%- endif -%}

<div ref="priceContainer">
  {% if show_sale_price_first == false and has_sale %}
    <s class="compare-at-price">{{ compare_display }}</s>
  {% endif %}

  <span class="price">{{ price_display | default: '&nbsp;' }}</span>

  {% if show_sale_price_first == true and has_sale %}
    <s class="compare-at-price">{{ compare_display }}</s>
  {% endif %}

  {%- if selected_variant.unit_price and show_unit_price -%}
    {%- liquid
      if product.handle == closest.product.handle and settings.currency_code_enabled_product_pages
        assign unit_price_display = selected_variant.unit_price | money_with_currency
      elsif product.handle != closest.product.handle and settings.currency_code_enabled_product_cards
        assign unit_price_display = selected_variant.unit_price | money_with_currency
      else
        assign unit_price_display = selected_variant.unit_price | money
      endif
    -%}
    {% render 'unit-price', variant: selected_variant, price: unit_price_display %}
  {%- endif -%}
</div>
